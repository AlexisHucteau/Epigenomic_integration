---
title: "R Notebook"
output: html_notebook
---

```{r}
source("packages.R")
#source("functions.R")

"%ni%" <- Negate("%in%")

load("../DATA/CD34/Methylation/BMIQ_CD34.Rdata")
load("../DATA/IDHm/Methylation/BMIQ_IDHm.RData")
```


```{r}
Blueprint <- read.csv("../BLUEPRINT_fragments_good.tsv", sep = "\t") %>%
  dplyr::select(., "gene_names":"type", "gene_type") %>%
  separate_rows(., gene_names, sep = " ") %>%
  separate_rows(., gene_type, sep = " ") %>%
  unique(.)

anno <- read.csv("~/Illumina_Manifest/HumanMethylation450_15017482_v1-2.csv", skip = 7) %>% 
  dplyr::select(., "Name", "CHR", "MAPINFO", "UCSC_RefGene_Name", "UCSC_RefGene_Group", "Relation_to_UCSC_CpG_Island") %>%
  dplyr::filter(., CHR != "") %>%
  separate_rows(., UCSC_RefGene_Name, UCSC_RefGene_Group, sep = ";")

Blueprint_Granges <- GRanges(
    seqnames = Blueprint$chr,
    ranges = IRanges(start = Blueprint$start, end = Blueprint$end),
    Blueprint_gene_names = Blueprint$gene_names,
    type = Blueprint$type,
    gene_type = Blueprint$gene_type
  )
CpGs_Granges <- GRanges(
  seqnames = anno$CHR,
  ranges = IRanges(anno$MAPINFO, anno$MAPINFO +1),
  CpG = anno$Name,
  Illumina_Gene_name = anno$UCSC_RefGene_Name,
  position = anno$UCSC_RefGene_Group,
  Island = anno$Relation_to_UCSC_CpG_Island
)
overlaps_CpGs_Blueprint <- findOverlaps(Blueprint_Granges, CpGs_Granges)
match_hit_CpGs_Blueprint <- data.frame(mcols(Blueprint_Granges[queryHits(overlaps_CpGs_Blueprint),]),
                                       data.frame(mcols(CpGs_Granges[subjectHits(overlaps_CpGs_Blueprint),])))

```

```{r}
gene_list <- c("CEBPA", "CPT1A", "CPT2", "SLC25A20", "AKT1", "AKT2", "AKT3", "PPARGC1A", "PTEN")

BMIQ_met <- read.csv("~/GitHub/TCGA_Connections/BMIQ_met.csv", row.names=1)

BMIQ_all <- merge(BMIQ_met, BMIQ_CD34, by.x = 0, by.y = 0)
rownames(BMIQ_all) <- BMIQ_all$Row.names
BMIQ_all <- BMIQ_all[,-1]

Phenotype <- data.frame("Sample" = colnames(BMIQ_all),"Phenotype" = ifelse(colnames(BMIQ_all) %in% colnames(BMIQ_IDHm), "IDHm", 
                    ifelse(colnames(BMIQ_all) %in% colnames(BMIQ_CD34), "CD34", "IDHWT")))


for (i in gene_list){
  Focus_Gene(i, BMIQ_all, match_hit_CpGs_Blueprint, show_cpgs = FALSE, Phenotype, title = "Promoter_methylation_IDHWT_CD34_IDHWT", diff = FALSE)
}
```

```{r}
TS <- Phenotype$Phenotype
TS <- factor(TS, levels = c("CD34", "IDHm", "IDHWT"))
design <- model.matrix(~ 0 + TS)
colnames(design) <- levels(TS)
fit <- lmFit(BMIQ_all, design)

cont.matrix <- makeContrasts(
  IDHm_vs_CD34 = CD34 - IDHm,
  IDHm_vs_IDHWT = IDHm - IDHWT,
  IDHWT_vs_CD34 = IDHWT - CD34,
  levels = design
)
fit.contrast <- contrasts.fit(fit, cont.matrix)
efit.contrast <- eBayes(fit.contrast)

filtered_DMP_IDHmvsCD34 <- data.frame(logFC = efit.contrast[["coefficients"]][,1], pvalue = efit.contrast[["p.value"]][,1]) %>%
  dplyr::filter(., logFC > 0.3 | logFC < -0.3) %>%
  dplyr::filter(., pvalue < 0.01) %>%
  merge(., BMIQ_all, by.x = 0, by.y = 0)
rownames(filtered_DMP_IDHmvsCD34) <- filtered_DMP_IDHmvsCD34$Row.names
filtered_DMP_IDHmvsCD34 <- filtered_DMP_IDHmvsCD34[,-1]

filtered_DMPIDHmvsIDHWT <- data.frame(logFC = efit.contrast[["coefficients"]][,2], pvalue = efit.contrast[["p.value"]][,2]) %>%
  dplyr::filter(., logFC > 0.3 | logFC < -0.3) %>%
  dplyr::filter(., pvalue < 0.01) %>%
  merge(., BMIQ_all, by.x = 0, by.y = 0)
rownames(filtered_DMPIDHmvsIDHWT) <- filtered_DMPIDHmvsIDHWT$Row.names
filtered_DMPIDHmvsIDHWT <- filtered_DMPIDHmvsIDHWT[,-1]

filtered_DMPIDHWT_vs_CD34 <- data.frame(logFC = efit.contrast[["coefficients"]][,3], pvalue = efit.contrast[["p.value"]][,3]) %>%
  dplyr::filter(., logFC > 0.3 | logFC < -0.3) %>%
  dplyr::filter(., pvalue < 0.01) %>%
  merge(., BMIQ_all, by.x = 0, by.y = 0)
rownames(filtered_DMPIDHWT_vs_CD34) <- filtered_DMPIDHWT_vs_CD34$Row.names
filtered_DMPIDHWT_vs_CD34 <- filtered_DMPIDHWT_vs_CD34[,-1]

Focus_global_methylation(filtered_DMP_IDHmvsCD34, match_hit_CpGs_Blueprint, Phenotype_df = Phenotype, title = "IDHmvsCD34 Global differential Promoter methylation", diff = TRUE)

Focus_global_methylation(filtered_DMPIDHmvsIDHWT, match_hit_CpGs_Blueprint, Phenotype_df = Phenotype, title = "IDHmvsIDHWT Global differential Promoter methylation", diff = TRUE)

Focus_global_methylation(filtered_DMPIDHWT_vs_CD34, match_hit_CpGs_Blueprint, Phenotype_df = Phenotype, title = "IDHWT_vs_CD34 Global differential Promoter methylation", diff = TRUE)

```


```{r}
for (i in gene_list){
  Focus_Gene(i, filtered_DMP_IDHmvsCD34, match_hit_CpGs_Blueprint, show_cpgs = TRUE, Phenotype, title = "Differential_promoter_methylation_IDHmvsCD34", diff = TRUE)
}
for (i in gene_list){
  Focus_Gene(i, filtered_DMPIDHmvsIDHWT, match_hit_CpGs_Blueprint, show_cpgs = TRUE, Phenotype, title = "Differential_promoter_methylation_IDHmvsIDHWT", diff = TRUE)
}
for (i in gene_list){
  Focus_Gene(i, filtered_DMPIDHWT_vs_CD34, match_hit_CpGs_Blueprint, show_cpgs = TRUE, Phenotype, title = "Differential_promoter_methylation_IDHWT_vs_CD34", diff = TRUE)
}
```

```{r}

gene = "CPT1A"
nb_sample <- 82
match_hit_CpGs_Blueprint_focused <- match_hit_CpGs_Blueprint %>%
  dplyr::filter(., .$Blueprint_gene_names == gene)
anno_focused <- anno %>% 
  dplyr::filter(., .$UCSC_RefGene_Name == gene) %>%
  dplyr::filter(., .$Name %ni% match_hit_CpGs_Blueprint_focused$CpG)
df_length <- length(anno_focused$Name)
to_add <- data.frame("Blueprint_gene_names" = rep(gene, df_length),
                     "type" = rep("In_promoter_Illumina_annotation_", df_length),
                     "gene_type" = rep("", df_length),
                     "CpG" = anno_focused$Name,
                     "Illumina_Gene_name" = anno_focused$UCSC_RefGene_Name,
                     "position" = anno_focused$UCSC_RefGene_Group,
                     "Island" = anno_focused$Relation_to_UCSC_CpG_Island)
final_matchit <- match_hit_CpGs_Blueprint_focused
Specific_CpGs_value <- merge(final_matchit, BMIQ_all, by.x = "CpG", by.y = 0, all.x = TRUE) 
Methylation <- dplyr::filter(Specific_CpGs_value, Blueprint_gene_names == gene) %>%
  na.omit(.) %>%
  unique(.)
Aggregated_CpGs <- data.frame("Beta_values" = colMeans2(as.matrix(Methylation[,1:82+7])), "Phenotype" = Phenotype$Phenotype)
Beta_value <- data.frame(c(Methylation[,1:82+7]) %>%
                           unlist(.) %>%
                           na.omit(.),
                         rep(Phenotype$Phenotype, each = length(rownames(Methylation))),
                         rep(Methylation$Island, nb_sample),
                         rep(Methylation$type, nb_sample) %>% ifelse(. == "P", "In_promoter_Blueprint_annotation", .),
                         rep(Methylation$position, nb_sample)) %>%
  unique(.)
colnames(Beta_value) <- c("Beta_values", "Phenotype", "cpg_localisation", "CpG_position", "Illumina_position_reference")

ggplot(Beta_value, aes(y=Beta_values, x=Phenotype, colour = CpG_position))+
    geom_boxplot(alpha=0.25)+
    #geom_jitter(Aggregated_CpGs, mapping = aes(y = Beta_values, x = Phenotype, colour = Phenotype), width=0.25, alpha=0.25)+
    ggtitle(gene)+
    xlab("Position of CpGs")+
    ylab("Value of the methylation")+
    scale_shape_manual(values=c(0,1,2,5,6,7))+
    geom_signif(comparisons = list(c("IDHWT", "IDHm")), map_signif_level=TRUE)

ggplot(Beta_value, aes(y=Beta_values, x=Phenotype, colour = CpG_position))+
    geom_boxplot(alpha=0.25)+
    geom_jitter(Aggregated_CpGs, mapping = aes(y = Beta_values, x = Phenotype, colour = Phenotype), width=0.25, alpha=0.25)+
    ggtitle(gene)+
    xlab("Position of CpGs")+
    ylab("Value of the methylation")+
    scale_shape_manual(values=c(0,1,2,5,6,7))+
    geom_signif(comparisons = list(c("IDHWT", "IDHm")), map_signif_level=TRUE)
```

