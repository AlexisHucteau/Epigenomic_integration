---
title: "R Notebook"
output: html_notebook
---

```{r}
source("packages.R")
#source("functions.R")

"%ni%" <- Negate("%in%")

load("../DATA/CD34/Methylation/BMIQ_CD34.Rdata")
load("../DATA/IDHm/Methylation/BMIQ_IDHm.RData")
load("../DATA/BMIQ_all.RData")
```


```{r}
Blueprint <- read.csv("../BLUEPRINT_fragments_good.tsv", sep = "\t") %>%
  dplyr::select(., "gene_names":"type", "gene_type") %>%
  separate_rows(., gene_names, sep = " ") %>%
  separate_rows(., gene_type, sep = " ") %>%
  unique(.)

anno <- read.csv("~/Illumina_Manifest/HumanMethylation450_15017482_v1-2.csv", skip = 7) %>% 
  dplyr::select(., "Name", "CHR", "MAPINFO", "UCSC_RefGene_Name", "UCSC_RefGene_Group", "Relation_to_UCSC_CpG_Island") %>%
  dplyr::filter(., CHR != "") %>%
  separate_rows(., UCSC_RefGene_Name, UCSC_RefGene_Group, sep = ";")

Blueprint_Granges <- GRanges(
    seqnames = Blueprint$chr,
    ranges = IRanges(start = Blueprint$start, end = Blueprint$end),
    Blueprint_gene_names = Blueprint$gene_names,
    type = Blueprint$type,
    gene_type = Blueprint$gene_type
  )
CpGs_Granges <- GRanges(
  seqnames = anno$CHR,
  ranges = IRanges(anno$MAPINFO, anno$MAPINFO +1),
  CpG = anno$Name,
  Illumina_Gene_name = anno$UCSC_RefGene_Name,
  position = anno$UCSC_RefGene_Group,
  Island = anno$Relation_to_UCSC_CpG_Island
)
overlaps_CpGs_Blueprint <- findOverlaps(Blueprint_Granges, CpGs_Granges)
match_hit_CpGs_Blueprint <- data.frame(mcols(Blueprint_Granges[queryHits(overlaps_CpGs_Blueprint),]),
                                       data.frame(mcols(CpGs_Granges[subjectHits(overlaps_CpGs_Blueprint),])))

```

```{r}
gene_list <- c("CEBPA", "CPT1A", "CPT2", "SLC25A20", "AKT1", "AKT2", "AKT3", "PPARGC1A", "PTEN")

BMIQ_met <- dplyr::select(BMIQ_all, colnames(BMIQ_all)[str_detect(colnames(BMIQ_all), "TCGA")])

Phenotype_TCGA <- read.csv("../../TCGA_Connections/Phenotype_met.csv") %>%
  dplyr::filter(., DNMT3A == "DNMT3AWT" & TET2 == "TET2WT" & WT1 == "WT1WT" & FLT3 == "FLT3AWT")
Phenotype_TCGA$X <- str_replace(Phenotype_TCGA$X, "-", ".") %>% str_replace(., "-", ".")

BMIQ_met <- dplyr::select(BMIQ_met, Phenotype_TCGA$X)

BMIQ_all <- merge(BMIQ_met, BMIQ_CD34, by = 0)
rownames(BMIQ_all) <- BMIQ_all$Row.names
BMIQ_all <- BMIQ_all[,-1]

Phenotype <- data.frame("Sample" = colnames(BMIQ_all),
                        "Phenotype" = ifelse(colnames(BMIQ_all) %in% colnames(BMIQ_IDHm), 
                                             "IDHm", ifelse(colnames(BMIQ_all) %in% colnames(BMIQ_CD34), 
                                                            "CD34", 
                                                            "IDHWT")))

Phenotype_no_CD34 <- data.frame("Sample" = colnames(BMIQ_met),
                                "Phenotype" = ifelse(colnames(BMIQ_met) %in% colnames(BMIQ_IDHm), 
                                                     "IDHm", 
                                                     "IDHWT"))
```


```{r}
for (i in gene_list){
  Focus_Gene(i, 
             BMIQ_met, 
             match_hit_CpGs_Blueprint, 
             show_cpgs = TRUE, 
             Phenotype_no_CD34, 
             diff = FALSE, 
             comparison = c("IDHm", "IDHWT"))
}
```


```{r}
for (i in gene_list){
  Focus_Gene(i, 
             BMIQ_all, 
             match_hit_CpGs_Blueprint, 
             show_cpgs = FALSE, 
             Phenotype, 
             diff = FALSE, 
             comparison = c("IDHm", "IDHWT"))
}
```

```{r}
TS <- Phenotype$Phenotype
TS <- factor(TS, levels = c("CD34", "IDHm", "IDHWT"))
design <- model.matrix(~ 0 + TS)
colnames(design) <- levels(TS)
fit <- lmFit(BMIQ_all, design)

cont.matrix <- makeContrasts(
  IDHm_vs_CD34 = CD34 - IDHm,
  IDHm_vs_IDHWT = IDHm - IDHWT,
  IDHWT_vs_CD34 = IDHWT - CD34,
  levels = design
)
fit.contrast <- contrasts.fit(fit, cont.matrix)
efit.contrast <- eBayes(fit.contrast)

filtered_DMP_IDHmvsCD34 <- data.frame(logFC = efit.contrast[["coefficients"]][,1], pvalue = efit.contrast[["p.value"]][,1]) %>%
  dplyr::filter(., logFC > 0.3 | logFC < -0.3) %>%
  dplyr::filter(., pvalue < 0.01) %>%
  merge(., BMIQ_all, by.x = 0, by.y = 0)
rownames(filtered_DMP_IDHmvsCD34) <- filtered_DMP_IDHmvsCD34$Row.names
filtered_DMP_IDHmvsCD34 <- filtered_DMP_IDHmvsCD34[,-1]

filtered_DMP_IDHmvsIDHWT <- data.frame(logFC = efit.contrast[["coefficients"]][,2], pvalue = efit.contrast[["p.value"]][,2]) %>%
  dplyr::filter(., logFC > 0.3 | logFC < -0.3) %>%
  dplyr::filter(., pvalue < 0.01) %>%
  merge(., BMIQ_all, by.x = 0, by.y = 0)
rownames(filtered_DMP_IDHmvsIDHWT) <- filtered_DMP_IDHmvsIDHWT$Row.names
filtered_DMP_IDHmvsIDHWT <- filtered_DMP_IDHmvsIDHWT[,-1]

filtered_DMP_IDHWT_vs_CD34 <- data.frame(logFC = efit.contrast[["coefficients"]][,3], pvalue = efit.contrast[["p.value"]][,3]) %>%
  dplyr::filter(., logFC > 0.3 | logFC < -0.3) %>%
  dplyr::filter(., pvalue < 0.01) %>%
  merge(., BMIQ_all, by.x = 0, by.y = 0)
rownames(filtered_DMP_IDHWT_vs_CD34) <- filtered_DMP_IDHWT_vs_CD34$Row.names
filtered_DMP_IDHWT_vs_CD34 <- filtered_DMP_IDHWT_vs_CD34[,-1]
```


```{r}
Focus_global_methylation(filtered_DMP_IDHmvsCD34, 
                         match_hit_CpGs_Blueprint, 
                         Phenotype_df = Phenotype, 
                         diff = TRUE, 
                         show_cpgs = TRUE, 
                         comparison = c("IDHm","CD34"), 
                         promoter = FALSE)

Focus_global_methylation(filtered_DMP_IDHmvsIDHWT, 
                         match_hit_CpGs_Blueprint, 
                         Phenotype_df = Phenotype, 
                         diff = TRUE, 
                         show_cpgs = TRUE, 
                         comparison = c("IDHm","IDHWT"), 
                         promoter = FALSE)

Focus_global_methylation(filtered_DMP_IDHWT_vs_CD34, 
                         match_hit_CpGs_Blueprint, 
                         Phenotype_df = Phenotype,
                         diff = TRUE, 
                         show_cpgs = TRUE, 
                         comparison = c("IDHWT","CD34"), 
                         promoter = FALSE)

Focus_global_methylation(filtered_DMP_IDHmvsCD34, 
                         match_hit_CpGs_Blueprint, 
                         Phenotype_df = Phenotype, 
                         diff = TRUE, 
                         show_cpgs = TRUE, 
                         comparison = c("IDHm","CD34"))

Focus_global_methylation(filtered_DMP_IDHmvsIDHWT,
                         match_hit_CpGs_Blueprint,
                         Phenotype_df = Phenotype,
                         diff = TRUE, 
                         show_cpgs = TRUE, 
                         comparison = c("IDHm","IDHWT"))

Focus_global_methylation(filtered_DMP_IDHWT_vs_CD34, 
                         match_hit_CpGs_Blueprint, 
                         Phenotype_df = Phenotype, 
                         diff = TRUE, 
                         show_cpgs = TRUE,
                         comparison = c("IDHWT","CD34"))

```
```{r}
TS_noCD34 <- Phenotype_no_CD34$Phenotype
TS_noCD34 <- factor(TS, levels = c("IDHm", "IDHWT"))
design_noCD34 <- model.matrix(~ 0 + TS_noCD34)
colnames(design_noCD34) <- levels(TS_noCD34)
fit_noCD34 <- lmFit(BMIQ_met, design_noCD34)

cont.matrix_noCD34 <- makeContrasts(
  IDHm_vs_IDHWT = IDHm - IDHWT,
  levels = design_noCD34
)
fit.contrast_noCD34 <- contrasts.fit(fit_noCD34, cont.matrix_noCD34)
efit.contrast_noCD34 <- eBayes(fit.contrast_noCD34)

filtered_DMP_IDHmvsIDHWT_noCD34 <- data.frame(logFC = efit.contrast_noCD34[["coefficients"]][,1], pvalue = efit.contrast_noCD34[["p.value"]][,1]) %>%
  dplyr::filter(., logFC > 0.3 | logFC < -0.3) %>%
  dplyr::filter(., pvalue < 0.01) %>%
  merge(., BMIQ_met, by.x = 0, by.y = 0)
rownames(filtered_DMP_IDHmvsIDHWT_noCD34) <- filtered_DMP_IDHmvsIDHWT_noCD34$Row.names
filtered_DMP_IDHmvsIDHWT_noCD34 <- filtered_DMP_IDHmvsIDHWT_noCD34[,-1]
```


```{r}
for (i in gene_list){
  Focus_Gene(i, 
             filtered_DMP_IDHmvsCD34,
             match_hit_CpGs_Blueprint, 
             show_cpgs = TRUE, 
             Phenotype, 
             diff = TRUE, 
             comparison = c("IDHm","CD34"))
}

for (i in gene_list){
  Focus_Gene(i,
             filtered_DMP_IDHmvsIDHWT_noCD34,
             match_hit_CpGs_Blueprint, 
             show_cpgs = TRUE, 
             Phenotype_no_CD34, 
             diff = TRUE, 
             comparison = c("IDHm","IDHWT"))
}

for (i in gene_list){
  Focus_Gene(i, 
             filtered_DMP_IDHWT_vs_CD34, 
             match_hit_CpGs_Blueprint, 
             show_cpgs = TRUE, 
             Phenotype, 
             diff = TRUE, 
             comparison = c("IDHWT","CD34"))
}
```

```{r}
Global_methylation(BMIQ_all, match_hit_CpGs_Blueprint, show_cpgs = FALSE, Phenotype, comparison = c("IDHm", "IDHWT"))
```

```{r}
load("../DATA/BMIQ_all.RData")

Phenotype_TCGA <- read.csv("../../TCGA_Connections/Phenotype_met.csv") %>%
  dplyr::filter(., WT1 == "WT1WT", DNMT3A == "DNMT3AWT", TET2 == "TET2WT")

Phenotype_TCGA$Phenotype <- ifelse(Phenotype_TCGA$IDH == "IDHm", "IDHm", 
                                   ifelse(Phenotype_TCGA$FLT3 == "FLT3m", "FLT3m", "WT"))
  
Phenotype_TCGA <- dplyr::select(Phenotype_TCGA, c(X, Phenotype)) %>%
  rbind(data.frame(X = colnames(BMIQ_CD34), Phenotype = rep("CD34", 6)))

Phenotype_TCGA$X <- str_replace(Phenotype_TCGA$X, "-", ".")
Phenotype_TCGA$X <- str_replace(Phenotype_TCGA$X, "-", ".")

DATA_met_CD34_IDH_FLT3 <- BMIQ_all %>%
  dplyr::select(., Phenotype_TCGA$X)
```

```{r}
for (i in gene_list){
  Focus_Gene_FLT3(i, DATA_met_CD34_IDH_FLT3, match_hit_CpGs_Blueprint, Phenotype_TCGA)
}
```



```{r}
load("../DATA/BMIQ_all.RData")

Phenotype_TCGA <- read.csv("../../TCGA_Connections/Phenotype_met.csv") %>%
  dplyr::filter(., WT1 == "WT1WT", DNMT3A == "DNMT3AWT", TET2 == "TET2WT")

Phenotype_TCGA$Phenotype <- ifelse(Phenotype_TCGA$IDH == "IDHm", "IDHm", 
                                   ifelse(Phenotype_TCGA$FLT3 == "FLT3m", "FLT3m", "WT"))
  
Phenotype_TCGA <- dplyr::select(Phenotype_TCGA, c(X, Phenotype)) %>%
  rbind(data.frame(X = colnames(BMIQ_CD34), Phenotype = rep("CD34", 6)))

Phenotype_TCGA$X <- str_replace(Phenotype_TCGA$X, "-", ".")
Phenotype_TCGA$X <- str_replace(Phenotype_TCGA$X, "-", ".")

DATA_met_CD34_IDH_FLT3 <- BMIQ_all %>%
  dplyr::select(., Phenotype_TCGA$X)

match_hit_CpGs_Blueprint_promoter <- dplyr::filter(match_hit_CpGs_Blueprint, type == "P")

anno_promoter <- dplyr::filter(anno, UCSC_RefGene_Group == "TSS1500" | UCSC_RefGene_Group == "TSS200")

Focus_Gene_global_methylation("CPT1A", match_hit_CpGs_Blueprint, anno_promoter, Phenotype_TCGA, DATA_met_CD34_IDH_FLT3, c("FLT3m", "WT"), c("#00FF00", "#888888", "#FF0000", "#0000FF"))

Focus_Gene_global_methylation("CEBPA", match_hit_CpGs_Blueprint, anno_promoter, Phenotype_no_CD34, BMIQ_met, c("IDHm", "IDHWT"), c("#FF0000", "#0000FF"))

for (i in gene_list){
  Focus_Gene_global_methylation(i, match_hit_CpGs_Blueprint, anno_promoter, Phenotype_no_CD34, BMIQ_met, c("IDHm", "IDHWT"), c("#FF0000", "#0000FF"))
}

CpGs_DM <- rownames(filtered_DMP_IDHmvsIDHWT)
  
for (i in gene_list){
  Focus_Gene_differential_methylation(i, match_hit_CpGs_Blueprint, anno_promoter, Phenotype_no_CD34, BMIQ_met, CpGs_DM, c("IDHm", "IDHWT"), c("#FF0000", "#0000FF"))
}


```